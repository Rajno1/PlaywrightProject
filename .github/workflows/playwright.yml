# ============================================================
# ADVANCED GITHUB ACTIONS WORKFLOW - PRODUCTION-READY
# ============================================================
# 
# NEW FEATURES ADDED:
# âœ… Pull Request checks
# âœ… Matrix testing (multiple browsers in parallel)
# âœ… Scheduled nightly runs
# âœ… Test result PR comments
# âœ… Flaky test retry
# âœ… Better caching for speed
# âœ… Slack notifications (optional)
# âœ… Performance tracking
# ============================================================

name: ğŸ­ Playwright E2E Tests (Advanced)

# â”€â”€â”€ TRIGGERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  # Trigger 1: Push to main/master
  push:
    branches: 
      - main
      - master
  
  # Trigger 2: Pull Requests (THIS IS NEW!)
  # Tests MUST pass before PR can be merged
  pull_request:
    branches: 
      - main
      - master
    types: [opened, synchronize, reopened]
  
  # Trigger 3: Manual run from GitHub UI
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Which tests to run?'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - regression
          - e2e
      
      browser:
        description: 'Which browser?'
        required: true
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit
          - all
  
  # Trigger 4: Scheduled runs (NEW!)
  # Runs every night at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM
    # - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM
    # - cron: '0 */6 * * *'  # Every 6 hours

# â”€â”€â”€ GLOBAL SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  ISSI_GMS_URL: ${{ secrets.ISSI_GMS_URL }}
  STAFF_USERNAME: ${{ secrets.STAFF_USERNAME }}
  STAFF_PASSWORD: ${{ secrets.STAFF_PASSWORD }}
  ORG_USERNAME: ${{ secrets.ORG_USERNAME }}
  ORG_PASSWORD: ${{ secrets.ORG_PASSWORD }}
  ORG_NAME: ${{ secrets.ORG_NAME }}
  IND_USERNAME: ${{ secrets.IND_USERNAME }}
  IND_PASSWORD: ${{ secrets.IND_PASSWORD }}
  HEADLESS: 'true'
  DEBUG: 'false'
  NODE_ENV: 'ci'

# Cancel in-progress runs if new push happens (saves resources)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# â”€â”€â”€ JOBS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: MATRIX TESTING (Multiple Browsers in Parallel)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  playwright-matrix:
    name: ğŸ§ª Test (${{ matrix.browser }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    
    # Matrix strategy - runs tests in PARALLEL
    # This creates 3 jobs automatically: chromium, firefox, webkit
    strategy:
      fail-fast: false  # Don't cancel other jobs if one fails
      matrix:
        browser: [chromium, firefox, webkit]
        os: [ubuntu-latest]
        # You can also test multiple OS:
        # os: [ubuntu-latest, windows-latest, macos-latest]
        # This would create 9 jobs (3 browsers Ã— 3 OS)
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # â”€â”€â”€ IMPROVED CACHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Cache Playwright browsers to speed up future runs
      - name: ğŸ“¦ Cache Playwright Browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸŒ Install Playwright Browsers
        # Only install if cache missed
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install ${{ matrix.browser }} --with-deps

      - name: ğŸ”‘ Create .env File
        run: |
          echo "ISSI_GMS_URL=${{ secrets.ISSI_GMS_URL }}" >> .env
          echo "STAFF_USERNAME=${{ secrets.STAFF_USERNAME }}" >> .env
          echo "STAFF_PASSWORD=${{ secrets.STAFF_PASSWORD }}" >> .env
          echo "ORG_USERNAME=${{ secrets.ORG_USERNAME }}" >> .env
          echo "ORG_PASSWORD=${{ secrets.ORG_PASSWORD }}" >> .env
          echo "ORG_NAME=${{ secrets.ORG_NAME }}" >> .env
          echo "IND_USERNAME=${{ secrets.IND_USERNAME }}" >> .env
          echo "IND_PASSWORD=${{ secrets.IND_PASSWORD }}" >> .env
          echo "HEADLESS=true" >> .env
          echo "DEBUG=false" >> .env

      # â”€â”€â”€ RUN TESTS WITH RETRY FOR FLAKY TESTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ­ Run Playwright Tests
        id: tests
        run: |
          # Determine which tests to run
          TEST_TYPE="${{ github.event.inputs.test_type || 'all' }}"
          BROWSER="${{ matrix.browser }}"
          
          echo "ğŸ” Running $TEST_TYPE tests on $BROWSER..."
          
          if [ "$TEST_TYPE" = "smoke" ]; then
            npx playwright test --project=$BROWSER --grep @smoke --retries=2
          elif [ "$TEST_TYPE" = "regression" ]; then
            npx playwright test --project=$BROWSER --grep @regression --retries=1
          elif [ "$TEST_TYPE" = "e2e" ]; then
            npx playwright test --project=$BROWSER --grep @e2e --retries=0
          else
            npx playwright test --project=$BROWSER --retries=1
          fi
        continue-on-error: true  # Don't fail job immediately

      # â”€â”€â”€ UPLOAD ARTIFACTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“Š Upload HTML Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}-${{ matrix.os }}
          path: playwright-report/
          retention-days: 30

      - name: ğŸ“‹ Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.browser }}-${{ matrix.os }}
          path: test-results/
          retention-days: 7

      # â”€â”€â”€ UPLOAD TRACE ON FAILURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¹ Upload Trace (on failure)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-traces-${{ matrix.browser }}
          path: test-results/**/trace.zip
          retention-days: 7

      # â”€â”€â”€ MARK JOB AS FAILED IF TESTS FAILED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âŒ Fail if Tests Failed
        if: steps.tests.outcome == 'failure'
        run: exit 1


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: QUICK SMOKE CHECK (Fastest feedback)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  smoke-check:
    name: ğŸ’¨ Quick Smoke Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    # Only run on push to main (not on PRs to save time)
    if: github.event_name == 'push' || github.event_name == 'schedule'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Cache Playwright Browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸŒ Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: ğŸ”‘ Create .env File
        run: |
          echo "ISSI_GMS_URL=${{ secrets.ISSI_GMS_URL }}" >> .env
          echo "STAFF_USERNAME=${{ secrets.STAFF_USERNAME }}" >> .env
          echo "STAFF_PASSWORD=${{ secrets.STAFF_PASSWORD }}" >> .env
          echo "ORG_USERNAME=${{ secrets.ORG_USERNAME }}" >> .env
          echo "ORG_PASSWORD=${{ secrets.ORG_PASSWORD }}" >> .env
          echo "ORG_NAME=${{ secrets.ORG_NAME }}" >> .env
          echo "IND_USERNAME=${{ secrets.IND_USERNAME }}" >> .env
          echo "IND_PASSWORD=${{ secrets.IND_PASSWORD }}" >> .env
          echo "HEADLESS=true" >> .env

      - name: ğŸ’¨ Run Smoke Tests
        run: npx playwright test --grep @smoke --retries=2

      - name: ğŸ“Š Upload Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-report
          path: playwright-report/
          retention-days: 7


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: COMMENT TEST RESULTS ON PR (NEW!)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  report-pr:
    name: ğŸ“ Comment Test Results on PR
    runs-on: ubuntu-latest
    needs: [playwright-matrix]
    if: always() && github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“Š Generate Test Summary
        id: summary
        run: |
          echo "### ğŸ­ Playwright Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Check each browser result
          for browser in chromium firefox webkit; do
            if [ -d "artifacts/playwright-report-$browser-ubuntu-latest" ]; then
              echo "| $browser | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $browser | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: ğŸ’¬ Comment PR with Results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read summary
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
            
            // Post comment on PR
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary + '\n\nğŸ“ Download full reports from the **Artifacts** section in the workflow run.'
            });


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: SLACK NOTIFICATION (Optional - NEW!)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify-slack:
    name: ğŸ“¢ Notify Slack
    runs-on: ubuntu-latest
    needs: [playwright-matrix, smoke-check]
    if: always() && (github.event_name == 'push' || github.event_name == 'schedule')
    
    steps:
      - name: ğŸ“¢ Send Slack Notification
        uses: slackapi/slack-github-action@v1.26.0
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "${{ needs.playwright-matrix.result == 'success' && 'âœ…' || 'âŒ' }} Playwright Tests ${{ needs.playwright-matrix.result }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Playwright Test Results*\n\nâ€¢ Status: ${{ needs.playwright-matrix.result }}\nâ€¢ Branch: ${{ github.ref_name }}\nâ€¢ Triggered by: ${{ github.actor }}\nâ€¢ Run: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }
              ]
            }
        # Note: This step will be skipped if SLACK_WEBHOOK_URL secret doesn't exist


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: PERFORMANCE TRACKING (NEW!)
  # Track test execution time over commits
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  performance-tracking:
    name: âš¡ Performance Tracking
    runs-on: ubuntu-latest
    needs: [playwright-matrix]
    if: github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“Š Store Performance Data
        run: |
          # Create performance log
          echo "Commit: ${{ github.sha }}" >> performance.log
          echo "Date: $(date)" >> performance.log
          echo "Duration: ${{ needs.playwright-matrix.outputs.duration }}" >> performance.log
          echo "---" >> performance.log

      - name: ğŸ“ˆ Commit Performance Log
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add performance.log || true
          git commit -m "ğŸ“Š Update performance tracking" || true
          git push || true